!function(i){"use strict"
    i.widget("sjaakp.cropper",{options:{aspectRatio:1,margin:40,diagonal:300,minSize:240,zoomMax:3,sliderPosition:"bottom",sliderOptions:{}},scale:1,zoom:1,crop:!0,loaded:!1,loadImage:function(i){var t,e,s=this
        if(this.crop=!0,this.overlay.show(),this.loaded=!1,this.preview.removeClass("sjaakp-state-loaded sjaakp-state-nocrop"),!i)return void this._empty()
        if(i instanceof FileList)t=i[0]
        else{if(!(i instanceof File))return void this._loadSrc(i)
            t=i}t.type.match(/image.*/)?(e=new FileReader,e.onload=function(i){s._loadSrc(i.target.result)},e.readAsDataURL(t)):this._empty()},_create:function(){this.img=i("<img>").addClass("sjaakp-img"),this.overlay=i("<div>").addClass("sjaakp-overlay"),this.preview=i("<div>").addClass("sjaakp-preview").append(this.img,this.overlay),this.slider=i("<div>").addClass("sjaakp-slider").slider(i.extend({},this.options.sliderOptions,{disabled:!0,min:1,max:this.options.zoomMax,step:.01,orientation:"top"===this.options.sliderPosition||"bottom"===this.options.sliderPosition?"horizontal":"vertical"})),this._calcPreviewSize(),this._setMargin(),this.element.append(this.preview),this._positionSlider(),this._on(this.slider,{slide:function(i,t){this._changeZoom(t.value)}})
        var t=!1
        this._on(this.overlay,{mousedown:function(i){if(1===i.which){var e={left:i.pageX,top:i.pageY},s=this.img.position()
            t=!0,this._on(this.document,{mousemove:function(i){t&&(this._setImgPosition({left:s.left+i.pageX-e.left,top:s.top+i.pageY-e.top}),this._report(),i.preventDefault())},mouseup:function(i){t&&(this._off(this.document,"mousemove mouseup"),t=!1,i.preventDefault())}}),i.preventDefault()}}})},_setOption:function(i,t){this._super(i,t),"sliderOptions"!==i&&(this._update(),"margin"===i?this._setMargin():"aspectRatio"===i&&this.loaded?this._centerImage():"sliderPosition"===i&&this._positionSlider()),this.loaded&&this._report()},_empty:function(){this.img.removeAttr("src"),this._reportNull(),this._reset()},_reset:function(){this.zoom=this.scale=1,this.slider.slider("option","value",1).slider("disable")},_loadSrc:function(i){var t=this,e=new Image
        e.src=i,e.onload=function(){t.nativeSize={width:this.width,height:this.height},t.img.attr("src",this.src),t.zoom=1,t.loaded=!0,t.slider.slider("option","value",1),t._update(),t._centerImage(),t.preview.addClass("sjaakp-state-loaded"),t._report()}},_update:function(){this._calcPreviewSize(),this.loaded&&(this._calcScale(),this._setImgSize(),this._setSlider())},_calcPreviewSize:function(){var i=this.options.aspectRatio,t=Math.sqrt(1+i*i),e=this.options.diagonal/t,s=2*this.options.margin,o=e*i+s,h=e+s
        this.previewSize={width:o,height:h},this.preview.css(this.previewSize),this._sizeSlider()},_calcScale:function(){var i=this.previewSize.width-2*this.options.margin,t=this.previewSize.height-2*this.options.margin,e=Math.max(i/this.nativeSize.width,t/this.nativeSize.height)
        e>1&&(e=1,this.overlay.hide(),this.preview.addClass("sjaakp-state-nocrop"),this._reset(),this.crop=!1,this._reportNull()),this.scale=e},_setImgSize:function(){var i=this.scale*this.zoom
        this.imgSize={width:i*this.nativeSize.width,height:i*this.nativeSize.height},this.img.css(this.imgSize),this._setImgPosition(this.img.position())},_setSlider:function(){var i,t=this.options.zoomMax
        this.options.minSize>0&&(i=this.options.aspectRatio>=1?this.previewSize.width:this.previewSize.height,i-=2*this.options.margin,i/=this.scale,t=i/this.options.minSize),this.zoom>t&&(this.zoom=Math.max(t,1),this._setImgSize()),t>1?this.slider.slider("option","max",t).slider("enable"):this._reset()},_positionSlider:function(){var i=this.options.sliderPosition
        this.slider.slider("option","orientation","top"===i||"bottom"===i?"horizontal":"vertical"),this.element.attr("class","sjaakp-cropper sjaakp-spos-"+this.options.sliderPosition),"top"===i||"left"===i?this.element.prepend(this.slider):this.element.append(this.slider),this._sizeSlider()},_sizeSlider:function(){var i=this.options.sliderPosition
        "top"===i||"bottom"===i?this.slider.width(this.preview.width()).height(""):this.slider.height(this.preview.height()).width("").find("a").css({left:""})},_setMargin:function(){this.overlay.css({borderWidth:this.options.margin})},_setImgPosition:function(i){var t=this.options.margin
        this.img.css({left:Math.max(Math.min(i.left,t),this.previewSize.width-this.imgSize.width-t),top:Math.max(Math.min(i.top,t),this.previewSize.height-this.imgSize.height-t)})},_changeZoom:function(i){var t=this.img.position(),e={left:this.previewSize.width/2-t.left,top:this.previewSize.height/2-t.top},s=i/this.zoom
        e.left*=s,e.top*=s,this.zoom=i,t.left=this.previewSize.width/2-e.left,t.top=this.previewSize.height/2-e.top,this.img.css(t),this._setImgSize(),this._report()},_centerImage:function(){this.img.css({left:(this.previewSize.width-this.imgSize.width)/2,top:(this.previewSize.height-this.imgSize.height)/2})},_report:function(){if(this.crop){var i=this.img.position(),t=this.options.margin,e=1/(this.scale*this.zoom)
        this._trigger("change",null,{aspect:this.options.aspectRatio,x:e*(t-i.left),y:e*(t-i.top),w:e*(this.previewSize.width-2*t),h:e*(this.previewSize.height-2*t)})}},_reportNull:function(){this._trigger("change",null,{aspect:this.options.aspectRatio,x:0,y:0,w:0,h:0})}})}(jQuery)