(function($){"use strict";$.widget("sjaakp.cropper",{options:{aspectRatio:1,margin:40,diagonal:300,minSize:240,sliderPosition:"bottom",sliderOptions:{}},scale:1,zoom:1,margin:40,crop:true,loaded:false,loadImage:function(file){var that=this,thisFile,reader;this.scale=this.zoom=1;this.margin=Number(this.options.margin);this.crop=true;this.loaded=false;this._setMargin();this.overlay.show();this.preview.removeClass("sjaakp-state-loaded sjaakp-state-nocrop");this.img.removeAttr("style");this.slider.slider("option",{value:1,max:1});this.img.removeAttr("src");this._reportNull();if(!file){return}if(file instanceof FileList){thisFile=file[0]}else if(file instanceof File){thisFile=file}else{this._loadSrc(file);return}if(thisFile.type.match(/image.*/)){reader=new FileReader;reader.onload=function(evt){that._loadSrc(evt.target.result)};reader.readAsDataURL(thisFile)}},_create:function(){this.img=$("<img>").addClass("sjaakp-img");this.overlay=$("<div>").addClass("sjaakp-overlay");this.preview=$("<div>").addClass("sjaakp-preview").append(this.img,this.overlay);this.slider=$("<div>").addClass("sjaakp-slider").slider($.extend({},this.options.sliderOptions,{min:1,max:1}));this._calcPreviewSize();this.margin=this.options.margin;this._setMargin();this.element.addClass("sjaakp-cropper").append(this.preview);this._positionSlider();this._reportNull();this._on(this.slider,{slide:function(evt,ui){this._changeZoom(ui.value)},dblclick:function(evt){this.slider.slider("option","value",1);this._changeZoom(1)}.bind(this)});var dragging=false;this._on(this.overlay,{mousedown:function(evt){if(evt.which===1){var d={left:evt.pageX,top:evt.pageY},startPos=this.imgPos;dragging=true;this._on(this.document,{mousemove:function(evt){if(dragging){this._moveImg({left:startPos.left+evt.pageX-d.left,top:startPos.top+evt.pageY-d.top});this._report();evt.preventDefault()}}.bind(this),mouseup:function(evt){if(dragging){this._off(this.document,"mousemove mouseup");dragging=false;evt.preventDefault()}}.bind(this)});evt.preventDefault()}}.bind(this)})},_setOption:function(key,value){if(key==="sliderPosition"){this.element.removeClass("sjaakp-spos-"+this.options.sliderPosition)}this._super(key,value);switch(key){case"aspectRatio":this._calcPreviewSize();this._calcScale();this._centerImg();this._report();break;case"margin":this.margin=Number(value);this._calcPreviewSize();this._calcScale();this._setMargin();this._moveImg(this.imgPos);break;case"diagonal":this._calcPreviewSize();this._calcScale();break;case"sliderPosition":this._positionSlider();break;case"minSize":this._calcScale();break;default:break}},_loadSrc:function(src){var that=this,preload=new Image;preload.src=src;preload.onload=function(){that.nativeSize={width:this.width,height:this.height};that.img.attr("src",this.src);that.loaded=true;that.preview.addClass("sjaakp-state-loaded");that._calcScale();if(that.crop){that._centerImg()}that._report()}},_calcPreviewSize:function(){var asp=this.options.aspectRatio,d=Math.sqrt(1+asp*asp),f=this.options.diagonal/d,margins=2*this.options.margin,w=f*asp+margins,h=f+margins;this.previewSize={width:w,height:h};this.preview.css(this.previewSize);this._sizeSlider()},_calcScale:function(){if(this.loaded){var cropWidth=this.previewSize.width-2*this.margin,cropHeight=this.previewSize.height-2*this.margin,scaleHor=cropWidth/this.nativeSize.width,scaleVert=cropHeight/this.nativeSize.height,scale=Math.max(scaleHor,scaleVert),scaleMax,maxZoom;scaleMax=Math.max(cropWidth,cropHeight)/this.options.minSize;if(scaleMax<scale){this.overlay.hide();this.preview.addClass("sjaakp-state-nocrop");this.crop=false;this._reportNull()}else{maxZoom=scaleMax/scale;if(maxZoom<this.zoom){this._changeZoom(maxZoom)}this.slider.slider("option",{max:maxZoom,step:maxZoom/100})}if(scale>=1){scale=1}this.scale=scale;this._setImgSize()}else{this.scale=1}},_setImgSize:function(){var f=this.scale*this.zoom;this.imgSize={width:f*this.nativeSize.width,height:f*this.nativeSize.height};if(this.crop){this.img.css(this.imgSize)}},_positionSlider:function(){var pos=this.options.sliderPosition;this.slider.slider("option","orientation",pos==="top"||pos==="bottom"?"horizontal":"vertical");this.element.addClass("sjaakp-spos-"+this.options.sliderPosition);if(pos==="top"||pos==="left"){this.element.prepend(this.slider)}else{this.element.append(this.slider)}this._sizeSlider()},_sizeSlider:function(){var pos=this.options.sliderPosition;if(pos==="top"||pos==="bottom"){this.slider.width(this.preview.width()).height("")}else{this.slider.height(this.preview.height()).width("").find("a").css({left:""})}},_setMargin:function(){this.overlay.css({borderWidth:this.margin})},_centerImg:function(){this._moveImg({left:0,top:0})},_moveImg:function(pos){var offset={left:(this.imgSize.width-this.previewSize.width)/2,top:(this.imgSize.height-this.previewSize.height)/2},contain={halfWidth:this.margin+offset.left,halfHeight:this.margin+offset.top};pos.left=Math.max(Math.min(pos.left,contain.halfWidth),-contain.halfWidth);pos.top=Math.max(Math.min(pos.top,contain.halfHeight),-contain.halfHeight);this.imgPos=pos;this.img.css({left:pos.left-offset.left,top:pos.top-offset.top})},_changeZoom:function(zoom){var pos=this.imgPos,f=zoom/this.zoom;pos.left*=f;pos.top*=f;this.zoom=zoom;this._setImgSize();this._moveImg(pos);this._report()},_report:function(){if(this.loaded&&this.crop){var posLeft=this.imgPos.left,posTop=this.imgPos.top,m=this.margin,f=1/(this.scale*this.zoom);posLeft=m+(this.imgSize.width-this.previewSize.width)/2-posLeft;posTop=m+(this.imgSize.height-this.previewSize.height)/2-posTop;this._trigger("change",null,{aspect:this.options.aspectRatio,x:f*posLeft,y:f*posTop,w:f*(this.previewSize.width-2*m),h:f*(this.previewSize.height-2*m)})}},_reportNull:function(){this._trigger("change",null,{aspect:this.options.aspectRatio,x:0,y:0,w:0,h:0})}})})(jQuery);